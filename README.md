# 噪声区域交易策略

## 项目简介

本项目实现了一个基于价格波动噪声区域的加密货币交易策略。该策略通过观察历史数据的波动特性，构建动态的价格上下边界，当价格突破这些边界时产生交易信号。

## 策略版本

项目提供了两个版本的策略实现：

1. **基础版本**：使用动态波动率计算边界，适合传统市场和常规交易。
2. **固定时间间隔版本**：在预设的固定时间点检查信号并做出决策，支持最大持仓时间限制，适合加密货币24小时交易。

## 功能特点

- 基于历史数据动态计算上下边界
- 支持固定时间点检查策略
- 内置追踪止损机制
- 最大持仓时间限制
- 考虑交易手续费和滑点
- 每日交易次数限制
- 详细的回测结果分析
- 全仓资金管理
- 资金曲线跟踪和回撤分析
- 直观的图表可视化
- 高效的大数据集处理优化

## 安装依赖

```bash
pip install pandas numpy matplotlib pytz
```

## 数据准备

### 获取历史数据

项目包含OKX交易所数据获取脚本，可一键下载历史K线数据：

```bash
python okx_candle_data.py
```

可在脚本开头修改配置参数：
- `SYMBOL`：交易对，如"BTC-USDT"
- `BAR`：K线周期，如"1m", "5m", "15m", "1H", "4H", "1D"
- `START_DATE`/`END_DATE`：数据起止日期
- `OUTPUT_FILE`：输出文件名

## 使用方法

```bash
python noise_region_strategy_backtest.py
```

### 配置参数

所有参数在代码文件顶部的`CONFIG`字典中配置：

```python
CONFIG = {
    "data_file": None,  # 设置为None会自动查找最新的BTC数据文件
    "source": "okx",
    "lookback_days": 3,  # 用于计算波动率的历史数据天数
    "k1": 1,  # 上边界乘数
    "k2": 1,  # 下边界乘数
    "max_trades_per_day": 3,  # 每日最大交易次数
    "commission_rate": 0,  # 手续费率（0.05%）
    "slippage": 0,  # 滑点（0.03%）
    "start_date": "2025-05-10",  # 只处理从这个日期开始的数据
    "initial_balance": 100000,  # 初始资金金额
    "check_interval": 10,  # 检查间隔（分钟），应用于入场、止损和超时检查
    "max_holding_minutes": 120  # 最大持仓时间（分钟）
}
```

### 新增参数说明

- **check_interval**：检查间隔（分钟），策略只在固定时间间隔点做出决策
- **max_holding_minutes**：最大持仓时间（分钟），超过该时间自动平仓

### 数据格式要求

输入数据必须是CSV格式，并且包含以下列：
- `timestamp`：时间戳
- `open`：开盘价
- `high`：最高价
- `low`：最低价
- `close`：收盘价

## 性能优化

本项目包含以下性能优化，使其能够高效处理大型数据集：

1. **缓存机制**：
   - sigma计算结果缓存，避免重复计算
   - 历史日期数据缓存，减少数据查询次数

2. **批处理优化**：
   - 时间点批量处理，减少内存占用
   - 进度跟踪和日志记录

3. **向量化操作**：
   - 使用pandas和numpy的向量化操作提高计算效率
   - 使用mask过滤代替循环遍历

## 输出结果

回测运行后会在`./output`目录下生成以下文件：

- `fixed_backtest_results.csv`：详细的回测结果数据
- `fixed_trades.csv`：所有交易记录
- `fixed_performance.csv`：性能指标总结
- `noise_region_fixed_backtest.png`：某一交易日的策略行为可视化
- `fixed_cumulative_pnl.png`：累计盈亏曲线
- `fixed_balance_history.png`：账户资金曲线（含最大回撤标记）
- `exit_reason_distribution.png`：退出原因分布
- `avg_pnl_by_exit_reason.png`：不同退出原因的平均盈亏

## 性能指标

回测结果包含以下性能指标：

- 总交易次数
- 盈利交易次数和亏损交易次数
- 胜率
- 总盈亏
- 平均每笔交易盈亏
- 最大回撤
- 夏普比率
- 初始资金和最终资金
- 总收益率（百分比）
- 不同退出原因（止损/超时）的交易统计
- 平均持仓时间

## 策略逻辑

### 固定时间间隔版本

1. 系统在每个交易日开始时计算当天的上下边界，基于前一日价格范围的1/4和3/4价位
2. 只在特定时间间隔点（由`check_interval`参数设定）检查交易信号
3. 价格突破上边界时做多，突破下边界时做空
4. 使用追踪止损：多头以上边界为止损线，空头以下边界为止损线
5. 持仓超过最大持仓时间（`max_holding_minutes`）时自动平仓
6. 当日交易次数达到上限（`max_trades_per_day`）后停止交易

## 数据过滤

您可以通过`CONFIG`中的`start_date`参数设置回测的起始日期，系统将只处理该日期及之后的数据。这有助于聚焦分析特定时间段，或者减少数据量加快处理速度。

## 注意事项

- 建议使用至少3天以上的数据进行回测，前面的天数用于计算历史波动率
- 策略参数需要根据不同市场和时间周期进行优化
- 回测结果仅供参考，实际交易可能受到更多因素影响
- 处理大型数据集时，请确保有足够的系统内存
- 固定时间间隔版本（如10分钟检查一次）可能不会捕获所有价格波动，但可以减少过度交易